
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Microsoft Licensing Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    select, button { margin: 0.5em 0; padding: 0.3em; }
    pre { background: #111; color: #0f0; padding: 0.5em; overflow: auto; display: none; }
    table { border-collapse: collapse; margin-top: 1em; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 0.4em; text-align: left; }
  </style>
</head>
<body>
  <h2>Select a Tenant</h2>
  <p>This tool allows Bit by Bit team members to look up Microsoft 365 user and licensing information for a selected customer tenant.</p>

  <select id="tenantDropdown"></select>
  <br/>
  <label><input type="checkbox" id="excludeEmpty"> Exclude users without any licenses</label>
  <br/>
  <button onclick="fetchLicensing()">Fetch Licensing Data</button>
  <br/>
  <a id="downloadBtn" href="#" download="LicensingData.json" style="display:none">⬇ Export JSON</a>

  <p><a href="#" onclick="toggleJSON(); return false;">▼ Show Raw JSON</a></p>
  <pre id="rawJson"></pre>
  <div id="grid"></div>

  <footer><small>Last updated: 2025-07-08 14:41 UTC | Revision 1.4</small></footer>

  <script>
    const licenseLookup = {
  "6fd2c87f-b296-42f0-b197-1e91e994b900": "Office 365 E3",
  "c42b9cae-ea4f-4ab7-9717-81576235ccac": "Microsoft 365 Business Basic",
  "18181a46-0d4e-45cd-891e-60aabd171b4e": "Microsoft 365 Business Standard",
  "a403ebcc-fae0-4ca2-8c8c-7a907fd6c235": "Microsoft 365 E5",
  "05e9a617-0261-4cee-bb44-138d3ef5d965": "Microsoft 365 E3",
  "4b9405b0-7788-4568-add1-99614e613b69": "Office 365 E1",
  "c7df2760-2c81-4ef7-b578-5b5392b571df": "Microsoft 365 F3",
  "e2b6c6e4-d6a9-4b07-bf44-138d3ef5d965": "Microsoft 365 Apps for business",
  "de376a4f-8328-4fe1-9fdb-e4c6a986be04": "Enterprise Mobility + Security E5",
  "b05e124f-c7cc-45a0-a6aa-8cf78c946968": "Microsoft Power BI Pro",
  "e95bec33-7c88-4a70-8e19-a462dfa90fc5": "Microsoft Defender for Endpoint Plan 1",
  "617b097b-4b93-4fae-9ddc-bebc77e68ee1": "Visio Plan 2"
};

    async function fetchLicensing() {
      const tenantId = document.getElementById("tenantDropdown").value;
      const excludeEmpty = document.getElementById("excludeEmpty").checked;
      const output = document.getElementById("rawJson");
      const grid = document.getElementById("grid");
      const download = document.getElementById("downloadBtn");

      output.textContent = "Fetching...";
      output.style.display = "block";
      grid.innerHTML = "";

      try {
        const res = await fetch(`https://func-bbb-tenantapi.azurewebsites.net/api/GetLicensingData?code=QcrX6LxbRDdEOL4aUTJbvqABR4H2VYZ0ERih0IgzP8zmAzFuZwrdpA==&tenantId=${tenantId}`);
        const data = await res.json();

        output.textContent = JSON.stringify(data, null, 2);
        download.style.display = "inline";
        download.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));

        const filtered = excludeEmpty ? data.filter(u => u.Licenses && u.Licenses[0] !== "None") : data;
        const table = document.createElement("table");
        const header = `
          <thead><tr>
            <th>Display Name</th>
            <th>User Principal Name</th>
            <th>Licenses</th>
            <th>Last Sign-In</th>
          </tr></thead>`;
        const rows = filtered.map(u => {
          const licenses = (u.Licenses || []).map(sku => licenseLookup[sku] || sku).join(', ') || "-";
          return `
            <tr>
              <td>${u.DisplayName || ''}</td>
              <td>${u.UserPrincipalName || ''}</td>
              <td>${licenses}</td>
              <td>${u.LastSignInDate || ''}</td>
            </tr>`;
        }).join('');

        table.innerHTML = header + "<tbody>" + rows + "</tbody>";
        grid.appendChild(table);
      } catch (err) {
        output.textContent = "Error fetching data: " + err;
      }
    }

    function toggleJSON() {
      const raw = document.getElementById("rawJson");
      raw.style.display = raw.style.display === "block" ? "none" : "block";
    }

    async function populateTenants() {
      const dropdown = document.getElementById("tenantDropdown");
      const res = await fetch("https://func-bbb-tenantapi.azurewebsites.net/api/GetTenants?code=QcrX6LxbRDdEOL4aUTJbvqABR4H2VYZ0ERih0IgzP8zmAzFuZwrdpA==");
      const tenants = await res.json();
      dropdown.innerHTML = tenants.map(t => `<option value="${t.TenantId}">${t.TenantName} (${t.TenantId})</option>`).join("");
    }

    populateTenants();
  </script>
</body>
</html>
